---
phase: 18-callbacks-promises
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/Concepts/PromisesThenCatchViz.tsx
  - src/components/Concepts/PromisesChainingViz.tsx
  - src/components/Concepts/index.ts
  - src/app/concepts/[conceptId]/ConceptPageClient.tsx
autonomous: true

must_haves:
  truths:
    - "User can see .then()/.catch() handlers registered and invoked"
    - "User can trace return values flowing through promise chain"
    - "User can see each .then() creates a new promise"
    - "User can observe sequential chaining where each step waits for previous"
  artifacts:
    - path: "src/components/Concepts/PromisesThenCatchViz.tsx"
      provides: "Then/catch chaining with return value flow"
      exports: ["PromisesThenCatchViz"]
    - path: "src/components/Concepts/PromisesChainingViz.tsx"
      provides: "Sequential promise chaining visualization"
      exports: ["PromisesChainingViz"]
  key_links:
    - from: "src/app/concepts/[conceptId]/ConceptPageClient.tsx"
      to: "PromisesThenCatchViz, PromisesChainingViz"
      via: "dynamic import in visualizations record"
      pattern: "promises-then-catch.*PromisesThenCatchViz|promise-chaining.*PromisesChainingViz"
---

<objective>
Create PromisesThenCatchViz and PromisesChainingViz components for teaching promise handler chaining.

Purpose: Learners understand that .then()/.catch() return NEW promises, values flow through the chain, and sequential operations wait for each previous step.
Output: Two self-contained Viz components following PromisesViz pattern with 3 difficulty levels each.
</objective>

<execution_context>
@/Users/sunnywilson/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sunnywilson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-callbacks-promises/18-RESEARCH.md
@src/components/Concepts/PromisesViz.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PromisesThenCatchViz component</name>
  <files>src/components/Concepts/PromisesThenCatchViz.tsx</files>
  <action>
Create PromisesThenCatchViz.tsx following PromisesViz.tsx pattern:

1. Add 'use client' directive at top
2. Define interfaces:
   - PromiseState: { id: string, label: string, state: 'pending'|'fulfilled'|'rejected', value?: string, reason?: string }
   - ValueFlow: { from: string, to: string, value: string, type: 'return'|'throw' }
   - Step: { id: number, phase: string, description: string, highlightLines: number[], promises: PromiseState[], valueFlows: ValueFlow[], activeHandler: 'then'|'catch'|'finally'|null, output: string[] }
   - Example: id, title, code (string[]), steps (Step[]), insight

3. Create examples for 3 levels:
   - Beginner (2 examples):
     * "Single .then()" - Promise.resolve(1).then(x => x + 1)
     * "Single .catch()" - Promise.reject('err').catch(e => 'handled')
   - Intermediate (2 examples):
     * ".then() Returns Value" - show return value becomes next promise's value
     * ".catch() Recovery" - catch returns value, chain continues in success path
   - Advanced (2 examples):
     * ".finally() Usage" - finally doesn't receive value, doesn't affect chain
     * "Throw in .then()" - throwing in then = rejection, caught by next catch

4. Unique visualization elements:
   - Promise chain (P1 -> P2 -> P3) with arrows between
   - Value flow arrows (animated, showing value moving between promises)
   - Active handler highlight (which .then/.catch is currently executing)
   - Handler return value display

5. Render structure:
   - Level/example selectors
   - Main visualization:
     * "Promise Chain" neon box:
       - Horizontal chain of promise cards
       - Animated arrows between them
       - Value labels on arrows
     * "Active Handler" indicator (then/catch/finally badge)
     * "Return Value" display when handler returns
   - Code panel with highlightLines
   - Output panel
   - Step description and controls
   - Key Insight

Animation: Values should animate along arrows (Framer Motion path animation or opacity fade).
  </action>
  <verify>
File exists, exports PromisesThenCatchViz, has value flow visualization.
Run: `grep -c "valueFlows\|activeHandler\|then\|catch" src/components/Concepts/PromisesThenCatchViz.tsx` returns 4+
  </verify>
  <done>PromisesThenCatchViz shows handler execution with return value flow</done>
</task>

<task type="auto">
  <name>Task 2: Create PromisesChainingViz component</name>
  <files>src/components/Concepts/PromisesChainingViz.tsx</files>
  <action>
Create PromisesChainingViz.tsx following PromisesViz.tsx pattern:

1. Add 'use client' directive at top
2. Define interfaces:
   - ChainedPromise: { id: string, label: string, state: 'pending'|'fulfilled'|'rejected', value?: string, waitingFor?: string }
   - Step: { id: number, phase: string, description: string, highlightLines: number[], promiseChain: ChainedPromise[], currentlyExecuting: string|null, output: string[] }
   - Example: id, title, code (string[]), steps (Step[]), insight

3. Create examples for 3 levels:
   - Beginner (2 examples):
     * "Two-Step Chain" - fetch().then(parse) - simple sequential
     * "Three-Step Chain" - fetch -> parse -> transform
   - Intermediate (2 examples):
     * "Async in Chain" - .then() returning another promise
     * "Data Transformation" - value transformation at each step
   - Advanced (2 examples):
     * "Long Chain" - 5+ steps showing full data pipeline
     * "Branching Chain" - conditional returns in .then()

4. Unique visualization elements:
   - Sequential chain timeline (vertical or horizontal)
   - "Waiting For" indicator (which previous promise)
   - Currently executing highlight
   - Value transformation display (input -> output at each step)

5. Render structure:
   - Level/example selectors
   - Main visualization:
     * "Promise Pipeline" neon box:
       - Chain of promise cards (vertically or horizontally)
       - "Waiting for..." label on pending promises
       - Currently executing promise highlighted
       - Value badge on each fulfilled promise
     * "Current Step" indicator
   - Code panel with highlightLines
   - Output panel
   - Step description and controls
   - Key Insight

Use AnimatePresence for chain growth (new promises appear with animation).
  </action>
  <verify>
File exists, exports PromisesChainingViz, has sequential chain visualization.
Run: `grep -c "waitingFor\|currentlyExecuting\|promiseChain" src/components/Concepts/PromisesChainingViz.tsx` returns 3+
  </verify>
  <done>PromisesChainingViz shows sequential promise chain with waiting indicators</done>
</task>

<task type="auto">
  <name>Task 3: Register components in index and ConceptPageClient</name>
  <files>
    src/components/Concepts/index.ts
    src/app/concepts/[conceptId]/ConceptPageClient.tsx
  </files>
  <action>
1. In src/components/Concepts/index.ts, add exports:
   ```typescript
   export { PromisesThenCatchViz } from './PromisesThenCatchViz'
   export { PromisesChainingViz } from './PromisesChainingViz'
   ```

2. In src/app/concepts/[conceptId]/ConceptPageClient.tsx:
   - Find the visualizations Record
   - Update/add entries (around lines 64-65):
   ```typescript
   'promises-then-catch': dynamic(() => import('@/components/Concepts/PromisesThenCatchViz').then(m => m.PromisesThenCatchViz)),
   'promise-chaining': dynamic(() => import('@/components/Concepts/PromisesChainingViz').then(m => m.PromisesChainingViz)),
   ```
   - Note: These may already point to PromisesViz - REPLACE them with the new components
  </action>
  <verify>
Run: `grep -c "PromisesThenCatchViz\|PromisesChainingViz" src/components/Concepts/index.ts` returns 2
Run: `grep "promises-then-catch\|promise-chaining" src/app/concepts/[conceptId]/ConceptPageClient.tsx | grep -v PromisesViz | wc -l` returns 2
  </verify>
  <done>Both components are exported and registered for dynamic loading</done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build` completes without errors
2. Components render: Navigate to /concepts/promises-then-catch and /concepts/promise-chaining
3. Value flow visible: Arrow animations show values moving through chain
4. Sequential waiting visible: "Waiting for P1" appears on P2 when P1 pending
</verification>

<success_criteria>
- PromisesThenCatchViz shows handler execution with return value flow
- PromisesChainingViz shows sequential chain with waiting indicators
- Both have 3 difficulty levels with multiple examples
- Code highlighting syncs with steps
- Key Insight displays for each example
</success_criteria>

<output>
After completion, create `.planning/phases/18-callbacks-promises/18-04-SUMMARY.md`
</output>
