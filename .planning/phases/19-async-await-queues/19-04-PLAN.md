---
phase: 19-async-await-queues
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/Concepts/MicrotaskQueueViz.tsx
  - src/components/Concepts/TaskQueueViz.tsx
  - src/components/Concepts/index.ts
  - src/app/concepts/[conceptId]/ConceptPageClient.tsx
autonomous: true

must_haves:
  truths:
    - "User can see microtasks drain completely before any macrotask runs"
    - "User can see microtasks spawning more microtasks during drain"
    - "User can see setTimeout/setInterval callbacks as macrotasks"
    - "User can see one-at-a-time macrotask execution with microtask checkpoint"
  artifacts:
    - path: "src/components/Concepts/MicrotaskQueueViz.tsx"
      provides: "Microtask queue deep dive visualization"
      min_lines: 250
      exports: ["MicrotaskQueueViz"]
    - path: "src/components/Concepts/TaskQueueViz.tsx"
      provides: "Macrotask queue visualization"
      min_lines: 250
      exports: ["TaskQueueViz"]
  key_links:
    - from: "src/app/concepts/[conceptId]/ConceptPageClient.tsx"
      to: "MicrotaskQueueViz"
      via: "dynamic import"
      pattern: "microtask-queue.*MicrotaskQueueViz"
    - from: "src/app/concepts/[conceptId]/ConceptPageClient.tsx"
      to: "TaskQueueViz"
      via: "dynamic import"
      pattern: "task-queue-macrotasks.*TaskQueueViz"
---

<objective>
Create MicrotaskQueueViz (microtask queue draining) and TaskQueueViz (macrotask queue processing).

Purpose: Users understand queue priority and the complete-drain behavior of microtasks vs one-at-a-time macrotasks.
Output: Two visualization components covering ASYNC-11 and ASYNC-12 requirements.
</objective>

<execution_context>
@/Users/sunnywilson/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sunnywilson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-async-await-queues/19-CONTEXT.md
@.planning/phases/19-async-await-queues/19-RESEARCH.md
@src/components/Concepts/EventLoopViz.tsx
@src/components/Concepts/EventLoopGranularViz.tsx
@src/components/SharedViz/index.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MicrotaskQueueViz component</name>
  <files>src/components/Concepts/MicrotaskQueueViz.tsx</files>
  <action>
Create MicrotaskQueueViz.tsx focusing on microtask queue behavior:

1. Structure:
   - 'use client' directive at top
   - Import useState, motion/AnimatePresence
   - Import icons from lucide-react
   - Import SharedViz components

2. Step interface:
   ```typescript
   interface QueueItem {
     id: string
     source: string  // 'Promise.then', 'queueMicrotask', 'MutationObserver'
     label: string
   }

   interface Step {
     description: string
     codeLine: number
     microQueue: QueueItem[]
     macroQueue: QueueItem[]
     currentlyDraining: boolean
     spawnedDuringDrain: string[]
     output: string[]
     phase: 'sync' | 'draining' | 'spawning' | 'macro-waiting' | 'complete'
   }
   ```

3. Examples by level:
   - Beginner: Promise.then vs setTimeout ordering
   - Intermediate: Microtask spawning another microtask during drain
     ```javascript
     queueMicrotask(() => {
       console.log('micro 1');
       queueMicrotask(() => {
         console.log('micro 2'); // runs before setTimeout!
       });
     });
     setTimeout(() => console.log('macro'), 0);
     // Output: micro 1, micro 2, macro
     ```
   - Advanced: Starvation warning - infinite microtask loop blocks macrotasks

4. Visual layout:
   - Prominent microtask queue (purple theme from EventLoopViz)
   - Dimmed macrotask queue (waiting indicator)
   - "DRAINING" indicator when processing microtasks
   - "SPAWNED DURING DRAIN" highlight for new microtasks

5. Queue styling (match EventLoopViz):
   - Microtask items: purple/violet colors
   - Macrotask items: amber/yellow colors (dimmed during microtask drain)
   - Slide-out animation using AnimatePresence mode="popLayout"
   - Items exit x: -20 (slide out left for FIFO)

6. Key insights:
   - Microtasks drain COMPLETELY before any macrotask
   - New microtasks added during drain run in same cycle
   - Macrotasks wait until microtask queue is empty
   - Starvation: infinite microtasks block everything
  </action>
  <verify>npm run build passes with no TypeScript errors</verify>
  <done>MicrotaskQueueViz.tsx exists with drain behavior visualization</done>
</task>

<task type="auto">
  <name>Task 2: Create TaskQueueViz component</name>
  <files>src/components/Concepts/TaskQueueViz.tsx</files>
  <action>
Create TaskQueueViz.tsx focusing on macrotask queue behavior:

1. Structure:
   - 'use client' directive at top
   - Import useState, motion/AnimatePresence
   - Import Timer, Clock from lucide-react
   - Import SharedViz components

2. Step interface:
   ```typescript
   interface MacroTask {
     id: string
     source: 'setTimeout' | 'setInterval' | 'I/O' | 'UI rendering'
     label: string
     delay?: number
   }

   interface Step {
     description: string
     codeLine: number
     macroQueue: MacroTask[]
     microQueue: string[]
     currentMacrotask?: string
     microCheckpoint: boolean
     output: string[]
     phase: 'sync' | 'macro' | 'micro-check' | 'idle'
   }
   ```

3. Examples by level:
   - Beginner: setTimeout(0) vs setTimeout(100) ordering
   - Intermediate: Multiple setTimeouts with microtask checkpoint between each
     ```javascript
     setTimeout(() => {
       console.log('macro 1');
       Promise.resolve().then(() => console.log('micro after macro 1'));
     }, 0);
     setTimeout(() => console.log('macro 2'), 0);
     // Output: macro 1, micro after macro 1, macro 2
     ```
   - Advanced: setInterval behavior, I/O callbacks, rendering timing

4. Visual layout:
   - Prominent macrotask queue (amber theme)
   - Small microtask queue showing checkpoint
   - "ONE AT A TIME" indicator
   - Source labels on each task (setTimeout, setInterval, etc.)

5. Key visual elements:
   - Task source icons (Timer for setTimeout, Clock for setInterval)
   - Delay indicator showing ms value
   - Microtask checkpoint indicator between macrotasks
   - "Processing" highlight on current macrotask

6. Key insights:
   - Macrotasks run one at a time
   - Microtask queue checked after EACH macrotask
   - setTimeout(0) doesn't mean immediate - minimum delay
   - setInterval can stack if callback takes too long
  </action>
  <verify>npm run build passes with no TypeScript errors</verify>
  <done>TaskQueueViz.tsx exists with macrotask queue visualization</done>
</task>

<task type="auto">
  <name>Task 3: Wire both queue components to routing</name>
  <files>src/components/Concepts/index.ts, src/app/concepts/[conceptId]/ConceptPageClient.tsx</files>
  <action>
1. In src/components/Concepts/index.ts:
   - Add exports:
     `export { MicrotaskQueueViz } from './MicrotaskQueueViz'`
     `export { TaskQueueViz } from './TaskQueueViz'`

2. In src/app/concepts/[conceptId]/ConceptPageClient.tsx:
   - Update 'microtask-queue' mapping (currently EventLoopGranularViz) to:
     `'microtask-queue': dynamic(() => import('@/components/Concepts/MicrotaskQueueViz').then(m => m.MicrotaskQueueViz))`
   - Update 'task-queue-macrotasks' mapping (currently EventLoopGranularViz) to:
     `'task-queue-macrotasks': dynamic(() => import('@/components/Concepts/TaskQueueViz').then(m => m.TaskQueueViz))`
  </action>
  <verify>npm run dev, navigate to both routes, components render without errors</verify>
  <done>Both routes render their respective dedicated components</done>
</task>

</tasks>

<verification>
1. `npm run build` passes
2. `npm run lint` produces no new warnings
3. /concepts/microtask-queue - shows microtask drain behavior
4. /concepts/task-queue-macrotasks - shows macrotask one-at-a-time behavior
5. Verify slide-out queue animations work correctly
6. Verify spawned-during-drain highlighting in microtask viz
7. Verify microtask checkpoint shown between macrotasks in task viz
</verification>

<success_criteria>
- MicrotaskQueueViz.tsx exists with complete-drain visualization
- TaskQueueViz.tsx exists with one-at-a-time visualization
- Queue animations match EventLoopViz patterns
- Microtask spawning during drain clearly shown
- Macrotask checkpoint between tasks visualized
- 3 difficulty levels on both components
- Mobile responsive layouts
</success_criteria>

<output>
After completion, create `.planning/phases/19-async-await-queues/19-04-SUMMARY.md`
</output>
