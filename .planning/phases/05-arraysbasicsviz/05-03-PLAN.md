---
phase: 05-arraysbasicsviz
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/components/Concepts/ArraysBasicsViz.tsx
  - src/components/Concepts/ArraysBasicsViz.module.css
autonomous: true

must_haves:
  truths:
    - "map/filter/reduce examples step through callback iterations"
    - "Filter shows rejected elements visually marked"
    - "Reduce accumulator value prominently displayed and updated"
    - "Result array grows progressively during iteration"
  artifacts:
    - path: "src/components/Concepts/ArraysBasicsViz.tsx"
      provides: "Advanced examples with method iteration"
      contains: "iterationState"
    - path: "src/components/Concepts/ArraysBasicsViz.module.css"
      provides: "Iteration visualization styles"
      contains: "accumulator"
  key_links:
    - from: "ArraysBasicsViz.tsx"
      to: "useAutoPlay hook"
      via: "import from SharedViz"
      pattern: "useAutoPlay"
---

<objective>
Add advanced examples demonstrating array method iteration (map/filter/reduce) with visual step-through of callback invocations.

Purpose: Learners understand how map/filter/reduce process arrays element by element, seeing the callback execute for each element and the result build up progressively.

Output: Advanced examples with iteration state visualization, accumulator display for reduce, and rejected element marking for filter.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-arraysbasicsviz/05-CONTEXT.md
@.planning/phases/05-arraysbasicsviz/05-RESEARCH.md
@.planning/phases/05-arraysbasicsviz/05-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add IterationState interface and advanced examples</name>
  <files>src/components/Concepts/ArraysBasicsViz.tsx</files>
  <action>
**Add IterationState interface** (for ArrayStep.iterationState optional field):

```typescript
interface IterationState {
  method: 'map' | 'filter' | 'reduce'
  currentIndex: number
  accumulator?: string | number  // For reduce
  resultArray?: (string | number)[]  // Growing result for map/filter
  rejected?: number[]  // Indices rejected by filter
}
```

Update ArrayStep interface to include:
```typescript
iterationState?: IterationState
```

**Create advanced examples array with 3 examples:**

**Example 1: "map() transforms each element"**
Code:
```javascript
const nums = [1, 2, 3]
const doubled = nums.map(x => x * 2)
console.log(doubled)
```

Steps (one step per element processed + setup/result):
1. setup: Array created in heap
2. iterate: Processing index 0, x=1, result so far: []
3. iterate: Processing index 1, x=2, result so far: [2]
4. iterate: Processing index 2, x=3, result so far: [2, 4]
5. result: Complete! doubled = [2, 4, 6]

Each iterate step should have iterationState with:
- method: 'map'
- currentIndex: 0/1/2
- resultArray: growing array

Insight: "map() calls the callback for EACH element and builds a new array from the results."

**Example 2: "filter() keeps matching elements"**
Code:
```javascript
const nums = [1, 2, 3, 4, 5]
const evens = nums.filter(x => x % 2 === 0)
console.log(evens)
```

Steps showing each element tested:
1. setup: Array created
2. iterate: Testing 1 (index 0), 1 % 2 !== 0, REJECTED
3. iterate: Testing 2 (index 1), 2 % 2 === 0, KEPT, result: [2]
4. iterate: Testing 3 (index 2), REJECTED
5. iterate: Testing 4 (index 3), KEPT, result: [2, 4]
6. iterate: Testing 5 (index 4), REJECTED
7. result: evens = [2, 4]

Each iterate step should have iterationState with:
- method: 'filter'
- currentIndex: 0-4
- resultArray: elements that passed
- rejected: array of indices that failed (e.g., [0, 2, 4])

Insight: "filter() tests each element. Passing elements join the result array; failing elements are discarded."

**Example 3: "reduce() accumulates to single value"**
Code:
```javascript
const nums = [1, 2, 3, 4]
const sum = nums.reduce((acc, x) => acc + x, 0)
console.log(sum)
```

Steps showing accumulator building:
1. setup: Array created, initial accumulator = 0
2. iterate: acc=0, x=1, acc + x = 1
3. iterate: acc=1, x=2, acc + x = 3
4. iterate: acc=3, x=3, acc + x = 6
5. iterate: acc=6, x=4, acc + x = 10
6. result: sum = 10

Each iterate step should have iterationState with:
- method: 'reduce'
- currentIndex: 0-3
- accumulator: running total

Insight: "reduce() carries an accumulator through each iteration, combining all elements into a single value."

Make descriptions very clear about what's happening at each step, including the current element value and the running result/accumulator.
  </action>
  <verify>`npm run build` passes, advanced array has 3 examples with iterationState in steps</verify>
  <done>3 advanced examples with iteration state tracking for map/filter/reduce</done>
</task>

<task type="auto">
  <name>Task 2: Add iteration visualization panel</name>
  <files>src/components/Concepts/ArraysBasicsViz.tsx, src/components/Concepts/ArraysBasicsViz.module.css</files>
  <action>
**Add iteration visualization panel** that appears when currentStep.iterationState exists:

Panel structure:
1. Method badge showing "map()" / "filter()" / "reduce()"
2. Source array visualization with current element highlighted
3. For map: Result array growing with new elements animating in
4. For filter: Source elements marked with checkmark (kept) or X (rejected)
5. For reduce: Prominent accumulator display showing current value

**Component implementation:**

```typescript
{currentStep.iterationState && (
  <div className={styles.iterationPanel}>
    <div className={styles.panelHeader}>
      <span className={styles.methodBadge}>
        {currentStep.iterationState.method}()
      </span>
      Processing element {currentStep.iterationState.currentIndex}
    </div>

    {/* Source array with current element highlighted */}
    <div className={styles.sourceArray}>
      <span className={styles.arrayLabel}>Source:</span>
      <div className={styles.elements}>
        {currentStep.heap[0]?.elements.map((el, i) => (
          <motion.span
            key={i}
            className={`${styles.element} ${
              i === currentStep.iterationState!.currentIndex ? styles.currentElement : ''
            } ${
              currentStep.iterationState!.rejected?.includes(i) ? styles.rejectedElement : ''
            }`}
          >
            {el}
          </motion.span>
        ))}
      </div>
    </div>

    {/* Result array for map/filter */}
    {currentStep.iterationState.resultArray && (
      <div className={styles.resultArray}>
        <span className={styles.arrayLabel}>Result:</span>
        <div className={styles.elements}>
          <AnimatePresence>
            {currentStep.iterationState.resultArray.map((el, i) => (
              <motion.span
                key={i}
                className={styles.resultElement}
                initial={{ opacity: 0, scale: 0.8, x: -10 }}
                animate={{ opacity: 1, scale: 1, x: 0 }}
                transition={{ delay: i * 0.1 }}
              >
                {el}
              </motion.span>
            ))}
          </AnimatePresence>
        </div>
      </div>
    )}

    {/* Accumulator for reduce */}
    {currentStep.iterationState.accumulator !== undefined && (
      <div className={styles.accumulatorPanel}>
        <span className={styles.accLabel}>Accumulator:</span>
        <motion.span
          key={currentStep.iterationState.accumulator}
          className={styles.accValue}
          initial={{ scale: 1.2, color: '#f97316' }}
          animate={{ scale: 1, color: '#e5e7eb' }}
        >
          {currentStep.iterationState.accumulator}
        </motion.span>
      </div>
    )}
  </div>
)}
```

**CSS styling:**

```css
.iterationPanel {
  background: rgba(249, 115, 22, 0.05);
  border: 1px solid rgba(249, 115, 22, 0.2);
  border-radius: 0.75rem;
  padding: 1rem;
  margin-top: 1rem;
}

.methodBadge {
  background: rgba(249, 115, 22, 0.2);
  color: #f97316;
  padding: 0.25rem 0.75rem;
  border-radius: 1rem;
  font-family: monospace;
  font-weight: 600;
  margin-right: 0.5rem;
}

.sourceArray, .resultArray {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-top: 0.75rem;
}

.arrayLabel {
  color: #9ca3af;
  font-size: 0.875rem;
  min-width: 4rem;
}

.elements {
  display: flex;
  gap: 0.25rem;
}

.element {
  background: #374151;
  padding: 0.5rem 0.75rem;
  border-radius: 0.375rem;
  font-family: monospace;
  border: 2px solid transparent;
}

.currentElement {
  border-color: #f97316;
  background: rgba(249, 115, 22, 0.2);
}

.rejectedElement {
  opacity: 0.4;
  text-decoration: line-through;
  background: rgba(239, 68, 68, 0.1);
}

.resultElement {
  background: rgba(16, 185, 129, 0.2);
  border: 1px solid #10b981;
}

.accumulatorPanel {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-top: 1rem;
  padding: 1rem;
  background: rgba(249, 115, 22, 0.1);
  border-radius: 0.5rem;
}

.accLabel {
  color: #9ca3af;
  font-weight: 500;
}

.accValue {
  font-size: 2rem;
  font-weight: 700;
  font-family: monospace;
  color: #e5e7eb;
}
```

The iteration panel should be visually prominent but not overshadow the main stack/heap visualization.
  </action>
  <verify>
- `npm run build` passes
- `npm run dev` - advanced examples show iteration panel
- map example shows result array growing
- filter example shows rejected elements with strikethrough
- reduce example shows accumulator updating prominently
  </verify>
  <done>Iteration visualization panel with method badge, current element highlight, result array animation, rejected element marking, and accumulator display</done>
</task>

</tasks>

<verification>
Run after all tasks:
- [ ] `npm run build` completes without errors
- [ ] `npm run lint` passes
- [ ] Advanced level accessible with 3 examples
- [ ] map() example: result array visibly grows element by element
- [ ] filter() example: rejected elements show strikethrough/X styling
- [ ] reduce() example: accumulator value updates with each step
- [ ] Current element being processed is highlighted in source array
- [ ] Iteration panel styled with orange accent
</verification>

<success_criteria>
1. 3 advanced examples for map/filter/reduce complete
2. Each method iteration visualized step by step
3. Current processing element highlighted
4. Filter rejected elements visually marked
5. Reduce accumulator prominently displayed and animated
6. Result arrays grow progressively with animation
</success_criteria>

<output>
After completion, create `.planning/phases/05-arraysbasicsviz/05-03-SUMMARY.md`
</output>
