---
phase: 21-closure-visualizations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/Concepts/ClosureDefinitionViz.tsx
autonomous: true

must_haves:
  truths:
    - "User can step through closure creation seeing [[Scope]] reference at function definition"
    - "User sees 'CLOSED OVER' badge when scope survives after function return"
    - "Arrows to parent scope visible showing lexical environment capture"
    - "User can switch between beginner/intermediate/advanced examples"
  artifacts:
    - path: "src/components/Concepts/ClosureDefinitionViz.tsx"
      provides: "Closure definition visualization with [[Scope]] references"
      contains: "ClosureDefinitionViz"
      min_lines: 200
  key_links:
    - from: "ClosureDefinitionViz.tsx"
      to: "ClosuresViz pattern"
      via: "ExecutionContext, HeapObject, Step interfaces"
      pattern: "interface ExecutionContext|interface HeapObject|interface Step"
---

<objective>
Create ClosureDefinitionViz component showing lexical environment capture at function creation.

Purpose: Teach the fundamental closure mechanism - how inner functions capture [[Scope]] reference to parent scope at creation time, and how that scope survives after the outer function returns.

Output: Fully functional ClosureDefinitionViz.tsx with beginner/intermediate/advanced examples demonstrating closure definition.
</objective>

<execution_context>
@/Users/sunnywilson/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sunnywilson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-closure-visualizations/21-RESEARCH.md
@src/components/Concepts/ClosuresViz.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ClosureDefinitionViz component</name>
  <files>src/components/Concepts/ClosureDefinitionViz.tsx</files>
  <action>
Create ClosureDefinitionViz.tsx following the ClosuresViz.tsx template pattern:

1. Add 'use client' directive at top
2. Import useState, useRef, useEffect from react, motion/AnimatePresence from framer-motion
3. Copy interfaces from ClosuresViz: ExecutionContext, HeapObject, Step, Example, Level, levelInfo
4. Create examples for three levels:

BEGINNER:
- "Basic Closure" - makeFunc example from MDN (single variable capture)
  - Shows function creation with [[Scope]] reference
  - Shows scope surviving after return with "CLOSED OVER" badge
  - 5-6 steps through Creation -> Execution -> Return -> Call

INTERMEDIATE:
- "Multiple Variables" - function capturing multiple variables
  - Show 2-3 variables captured in single scope
  - Include mutation example (modifying closed-over variable)
- "Factory Function" - createAdder pattern
  - Show multiple independent closures from same factory
  - Each closure has its own captured scope

ADVANCED:
- "Nested Closures" - closure over closure
  - Outer function returns inner function that returns innermost function
  - Show scope chain: innermost -> inner -> outer
  - Demonstrate [[Scope]] chaining

5. Component structure (match ClosuresViz exactly):
   - Level selector (beginner/intermediate/advanced pill buttons)
   - Example selector (tabs for examples within level)
   - Code panel with line highlighting and phase badge
   - Memory visualization grid: Call Stack | Heap Memory (with [[Scope]] arrows)
   - Output panel
   - Step description with step counter
   - Controls: Prev | Next | Reset
   - Key insight box

6. State management:
   - level, exampleIndex, stepIndex useState hooks
   - lineRefs for auto-scrolling
   - Reset stepIndex to 0 when changing level or example

7. Visual elements:
   - Use neon box styling from ClosuresViz (gradient borders)
   - "CLOSED OVER" badge appears when scope survives function return
   - [[Scope]] displayed with purple color and arrow notation
   - Phase badge (Creation/Execution/Return)

Key implementation notes:
- Show references not values (arrows to scope objects)
- Include mutation example showing closed-over variable can change
- HeapObject scopeRef field enables visual linking
- Use AnimatePresence for smooth step transitions
  </action>
  <verify>
    - File exists: ls -la src/components/Concepts/ClosureDefinitionViz.tsx
    - No TypeScript errors: npx tsc --noEmit src/components/Concepts/ClosureDefinitionViz.tsx 2>&1 | head -20
    - Component renders: npm run build 2>&1 | grep -i error || echo "Build passed"
  </verify>
  <done>
    - ClosureDefinitionViz.tsx exists with 'use client' directive
    - Three difficulty levels with 2+ examples each
    - [[Scope]] references shown with arrows to parent scope
    - "CLOSED OVER" badge appears when scope survives
    - Level/example/step navigation works
    - Matches ClosuresViz visual style
  </done>
</task>

<task type="auto">
  <name>Task 2: Register ClosureDefinitionViz in concepts data</name>
  <files>src/data/concepts.ts</files>
  <action>
Add ClosureDefinitionViz to the concepts data file:

1. Import ClosureDefinitionViz at top of file:
   import { ClosureDefinitionViz } from '@/components/Concepts/ClosureDefinitionViz'

2. Add new concept entry for closure definition visualization:
   - id: 'closure-definition'
   - title: 'Closure Definition'
   - description: 'Understanding how closures capture lexical scope'
   - category: appropriate category (likely 'closures' or 'functions')
   - component: ClosureDefinitionViz
   - keyPoints: focus on [[Scope]], lexical environment, scope survival
   - interviewTips: common closure interview questions

Follow the existing pattern for other concept entries in the file.
  </action>
  <verify>
    - Concept registered: grep -n "closure-definition\|ClosureDefinitionViz" src/data/concepts.ts
    - Import present: grep -n "import.*ClosureDefinitionViz" src/data/concepts.ts
    - No syntax errors: npx tsc --noEmit src/data/concepts.ts 2>&1 | head -10
  </verify>
  <done>
    - ClosureDefinitionViz imported in concepts.ts
    - Concept entry added with id 'closure-definition'
    - Component wired to concept data
    - TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
1. Component file exists and compiles:
   - ls src/components/Concepts/ClosureDefinitionViz.tsx
   - npx tsc --noEmit

2. Build passes:
   - npm run build

3. Lint passes:
   - npm run lint -- --max-warnings=0 src/components/Concepts/ClosureDefinitionViz.tsx
</verification>

<success_criteria>
- ClosureDefinitionViz.tsx renders closure creation with [[Scope]] arrows
- Three difficulty levels with meaningful examples at each
- "CLOSED OVER" badge appears at correct step (scope survival)
- Component registered in concepts.ts and accessible via routing
- Build and lint pass with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/21-closure-visualizations/21-01-SUMMARY.md`
</output>
