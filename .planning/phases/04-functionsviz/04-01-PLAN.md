---
phase: 04-functionsviz
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/Concepts/FunctionsViz.tsx
  - src/components/Concepts/FunctionsViz.module.css
autonomous: true

must_haves:
  truths:
    - "User can select beginner/intermediate/advanced levels"
    - "User can switch between examples within a level"
    - "User can step through function execution forwards and backwards"
    - "Call stack shows frames being pushed and popped with animation"
    - "Execution context creation and destruction steps are visible"
  artifacts:
    - path: "src/components/Concepts/FunctionsViz.tsx"
      provides: "FunctionsViz component with step-through visualization"
      contains: "FunctionStep"
    - path: "src/components/Concepts/FunctionsViz.module.css"
      provides: "Styling for call stack, execution context, level selector"
      contains: "callStack"
  key_links:
    - from: "FunctionsViz.tsx"
      to: "@/components/SharedViz"
      via: "import"
      pattern: "import.*CodePanel.*StepProgress.*StepControls.*SharedViz"
    - from: "FunctionsViz.tsx"
      to: "framer-motion"
      via: "import"
      pattern: "import.*AnimatePresence.*motion.*framer-motion"
---

<objective>
Complete FunctionsViz rewrite as step-through visualization with call stack and execution context display

Purpose: Enable learners to step through function execution, seeing call stack frames push/pop and execution contexts created/destroyed
Output: FunctionsViz component with types, beginner examples, level/example/step navigation, call stack panel, and execution context display
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-functionsviz/04-CONTEXT.md
@.planning/phases/04-functionsviz/04-RESEARCH.md
@src/components/Concepts/FunctionsViz.tsx
@src/components/Concepts/FunctionsViz.module.css
@src/components/Concepts/LoopsViz.tsx
@src/components/Concepts/LoopsViz.module.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define types and create beginner example data</name>
  <files>src/components/Concepts/FunctionsViz.tsx</files>
  <action>
Define TypeScript interfaces following the LoopsViz pattern:

1. **FunctionStep interface:**
```typescript
interface FunctionStep {
  id: number
  codeLine: number
  description: string
  phase: 'setup' | 'call' | 'enter' | 'execute' | 'return' | 'cleanup'
  callStack: CallStackFrame[]
  output: string[]
}
```

2. **CallStackFrame interface:**
```typescript
interface CallStackFrame {
  id: string
  name: string
  params: Record<string, string>
  locals: Record<string, string>
  thisValue: string
  outerRef: string | null
  status: 'creating' | 'active' | 'returning' | 'destroyed'
}
```

3. **FunctionExample interface:**
```typescript
interface FunctionExample {
  id: string
  title: string
  code: string[]
  steps: FunctionStep[]
  insight: string
}
```

4. **Level type and levelInfo:**
```typescript
type Level = 'beginner' | 'intermediate' | 'advanced'
const levelInfo: Record<Level, { label: string; color: string }> = {
  beginner: { label: 'Beginner', color: '#10b981' },
  intermediate: { label: 'Intermediate', color: '#f59e0b' },
  advanced: { label: 'Advanced', color: '#ef4444' }
}
```

5. **Create 3 beginner examples:**

Example 1: "Simple function call" - Basic function declaration, call, return
- Steps show: setup (function defined), call (function invoked), enter (context created, pushed to stack), execute (body runs), return (value returned), cleanup (context destroyed, popped from stack)
- Call stack visualization: global -> greet() -> global

Example 2: "Nested function calls" - Function A calls function B
- Steps show: stack growing (global -> outer -> inner), then shrinking (inner returns -> outer returns -> global)
- Demonstrates stack LIFO behavior
- 2 levels of nesting (outer calls inner)

Example 3: "Function with local variables" - Show locals in execution context
- Steps show: context creation with locals, locals being assigned, context destroyed
- Execution context displays: params, locals, thisValue (window/undefined)

Each step must have explicit `callStack` array showing current stack state. Use frame `status` to animate creation/destruction:
- 'creating' = frame animating in
- 'active' = frame fully visible
- 'returning' = frame showing return value
- 'destroyed' = frame animating out (not in array)

Keep intermediate and advanced arrays empty: `intermediate: [], advanced: []`
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit` passes</verify>
  <done>FunctionStep, CallStackFrame, FunctionExample interfaces defined. 3 beginner examples created with explicit callStack arrays showing stack state at each step.</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite component with level/example/step navigation and call stack panel</name>
  <files>src/components/Concepts/FunctionsViz.tsx, src/components/Concepts/FunctionsViz.module.css</files>
  <action>
Rewrite FunctionsViz component following LoopsViz pattern:

**Component structure:**
1. Import SharedViz components: `import { CodePanel, StepProgress, StepControls } from '@/components/SharedViz'`
2. State: `level`, `exampleIndex`, `stepIndex` (all with reset handlers)
3. Derived: `currentExamples`, `currentExample`, `currentStep`
4. Early return with fallback if `!currentStep`

**Layout (top to bottom):**
1. Level selector (beginner/intermediate/advanced pills with colored dots)
2. Example tabs (switch between examples in current level)
3. Main grid:
   - Left: CodePanel with current code and highlighted line
   - Right: Call Stack panel
4. StepProgress (step X/Y with description)
5. StepControls (Prev/Next/Reset)
6. Key Insight box

**Call Stack panel implementation:**
```tsx
<div className={styles.callStackPanel}>
  <div className={styles.panelHeader}>Call Stack</div>
  <div className={styles.stackFrames}>
    <AnimatePresence mode="popLayout">
      {currentStep.callStack.slice().reverse().map((frame) => (
        <motion.div
          key={frame.id}
          className={`${styles.stackFrame} ${styles[frame.status]}`}
          initial={{ opacity: 0, y: -20, scale: 0.95 }}
          animate={{ opacity: 1, y: 0, scale: 1 }}
          exit={{ opacity: 0, y: 20, scale: 0.95 }}
          layout
        >
          <div className={styles.frameName}>{frame.name}</div>
          {Object.keys(frame.params).length > 0 && (
            <div className={styles.frameSection}>
              <span className={styles.sectionLabel}>params:</span>
              {Object.entries(frame.params).map(([k, v]) => (
                <span key={k} className={styles.variable}>{k}: {v}</span>
              ))}
            </div>
          )}
          {Object.keys(frame.locals).length > 0 && (
            <div className={styles.frameSection}>
              <span className={styles.sectionLabel}>locals:</span>
              {Object.entries(frame.locals).map(([k, v]) => (
                <span key={k} className={styles.variable}>{k}: {v}</span>
              ))}
            </div>
          )}
          <div className={styles.frameSection}>
            <span className={styles.sectionLabel}>this:</span>
            <span className={styles.thisValue}>{frame.thisValue}</span>
          </div>
          {frame.outerRef && (
            <div className={styles.frameSection}>
              <span className={styles.sectionLabel}>outer:</span>
              <span className={styles.outerRef}>{frame.outerRef}</span>
            </div>
          )}
        </motion.div>
      ))}
    </AnimatePresence>
  </div>
</div>
```

**CSS styling (FunctionsViz.module.css):**
- Use purple accent: `--js-viz-accent: #8b5cf6`
- Follow LoopsViz styling patterns for level selector, example tabs
- Stack frames: dark background, border, padding
- Frame status styles: `.creating` (opacity 0.7), `.active` (full opacity, accent border), `.returning` (green tint for return)
- Vertical stack layout (newest on top via slice().reverse())
- Animation transitions matching LoopsViz

Reset stepIndex to 0 when level or example changes.
  </action>
  <verify>
1. `npm run build` passes
2. Visit `/concepts/functions` in browser
3. Level selector shows Beginner active, Intermediate/Advanced disabled
4. Example tabs show all 3 beginner examples
5. Stepping through shows call stack frames push/pop with animation
6. Code highlighting syncs with current step
  </verify>
  <done>
FunctionsViz rewritten with:
- Level/example/step navigation matching LoopsViz pattern
- Call stack panel showing frames with push/pop animations
- Execution context (params, locals, this, outer) visible in each frame
- SharedViz components integrated (CodePanel, StepProgress, StepControls)
- Purple accent color (#8b5cf6)
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Build passes
3. Component renders at /concepts/functions
4. Level selector functional (beginner active, others disabled)
5. Example tabs switch between 3 beginner examples
6. Step navigation works (Prev/Next/Reset)
7. Call stack frames animate in/out
8. Execution context displayed in frames
9. Code highlighting syncs with steps
</verification>

<success_criteria>
- FunctionsViz displays step-through visualization with call stack
- User can step through function execution seeing stack grow and shrink
- Execution context (params, locals, this, outer) visible in each frame
- Frame animations smooth (push slides in from top, pop slides out to bottom)
- 3 beginner examples demonstrate basic calls, nested calls, and local variables
</success_criteria>

<output>
After completion, create `.planning/phases/04-functionsviz/04-01-SUMMARY.md`
</output>
