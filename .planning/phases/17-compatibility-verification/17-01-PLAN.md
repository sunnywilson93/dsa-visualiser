---
phase: 17-compatibility-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/check-vars.ts
  - scripts/check-keyframes.ts
  - scripts/tokens-audit.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "npm run check:vars scans all CSS Module files and reports any var() references that cannot resolve from globals.css or local scope"
    - "npm run check:keyframes reports any @keyframes defined inside .module.css files (should be zero -- all in @theme)"
    - "npm run tokens:audit prints a summary of defined vs used tokens showing unused and unresolved"
  artifacts:
    - path: "scripts/check-vars.ts"
      provides: "Static var() reference checker using PostCSS AST"
      min_lines: 80
    - path: "scripts/check-keyframes.ts"
      provides: "Lint rule preventing @keyframes in CSS Modules"
      min_lines: 30
    - path: "scripts/tokens-audit.ts"
      provides: "Token usage audit showing defined vs used"
      min_lines: 60
  key_links:
    - from: "package.json"
      to: "scripts/check-vars.ts"
      via: "npm script check:vars"
      pattern: "check:vars"
    - from: "package.json"
      to: "scripts/tokens-audit.ts"
      via: "npm script tokens:audit"
      pattern: "tokens:audit"
---

<objective>
Create three static analysis scripts for CSS custom property verification, keyframes lint enforcement, and token usage auditing. These become permanent CI-ready npm scripts.

Purpose: Provide fast, automated checks that catch missing/broken custom properties without running the app, enforce the @theme keyframes consolidation rule, and give visibility into token usage across the codebase.

Output: Three TypeScript scripts in `scripts/` directory, three new npm scripts in package.json.
</objective>

<execution_context>
@/Users/sunnywilson/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sunnywilson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/styles/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create static var() reference checker script</name>
  <files>scripts/check-vars.ts, package.json</files>
  <action>
Create `scripts/check-vars.ts` using PostCSS and postcss-value-parser to:

1. Parse `src/styles/globals.css` using PostCSS to collect ALL defined custom properties (from @theme block AND @layer base :root). Build a Set of defined property names.

2. Scan all `src/**/*.module.css` files using PostCSS. For each file:
   - Walk all declarations and use postcss-value-parser to extract every `var()` reference
   - For each var() reference, extract the property name (first argument)
   - Check if it has a fallback value (second argument after comma)
   - Collect properties defined locally within the same CSS Module file (component-scoped vars)

3. For each var() reference found:
   - PASS if property is in the globals.css defined set
   - PASS if property is defined locally in the same CSS Module file
   - PASS if the var() has a fallback value (e.g., `var(--text-muted, #888)`)
   - PASS if property is in a known-dynamic-props allowlist for inline-style-injected properties: `--era-color`, `--frame-color`, `--js-viz-primary`, `--js-viz-secondary`, `--js-viz-tertiary`, `--js-viz-quaternary`, `--neon-start`, `--neon-end`, `--delay`, `--glow-color`, `--category-color`, `--category-bg`, `--step-color`, `--topic-color`, `--topic-bg`, `--arrow-x`, `--arrow-rotate`, `--level-color`, `--bucket-color`, `--bit-color`, `--result-color`, `--active-color`, `--stagger`
   - FAIL otherwise (unresolved reference)

4. Output:
   - If all pass: "All var() references resolve correctly. {N} references checked across {M} files."
   - If any fail: List each unresolved reference with file path, line number, and property name. Exit with code 1.

Install `postcss-value-parser` as a devDependency. Use `tsx` (already likely available via Next.js toolchain or install as devDep) to run the script.

Add to package.json scripts: `"check:vars": "npx tsx scripts/check-vars.ts"`
  </action>
  <verify>Run `npm run check:vars` -- should pass with zero unresolved references (or identify real issues to fix in Plan 03)</verify>
  <done>Script exits 0 with summary message showing all var() references resolve, or exits 1 listing specific unresolved references with file:line details</done>
</task>

<task type="auto">
  <name>Task 2: Create keyframes lint and token audit scripts</name>
  <files>scripts/check-keyframes.ts, scripts/tokens-audit.ts, package.json</files>
  <action>
**check-keyframes.ts:**
Create a script that scans all `src/**/*.module.css` files using PostCSS and checks for any `@keyframes` at-rules. Phase 16 consolidated all keyframes into @theme, so CSS Modules should have zero @keyframes.

- Parse each .module.css file with PostCSS
- Walk all at-rules, check for `atRule.name === 'keyframes'`
- If any found: report file path, keyframe name, exit with code 1
- If none found: print "No @keyframes in CSS Modules. All animations correctly in @theme."

Add npm script: `"check:keyframes": "npx tsx scripts/check-keyframes.ts"`

**tokens-audit.ts:**
Create a script that produces a usage report:

1. Parse globals.css to collect all defined custom properties (property name -> value)
2. Scan all .module.css files to collect all var() references (property name -> list of files using it)
3. Output a structured report:
   - Total defined tokens: N
   - Total unique references: M
   - **Unused tokens** (defined but never referenced in any module): list with property names
   - **Unresolved references** (referenced but not defined globally): list with property names and files
   - **Component-scoped** (defined and used within same module): list
4. Exit 0 always (informational tool, not a gate)

Add npm script: `"tokens:audit": "npx tsx scripts/tokens-audit.ts"`
  </action>
  <verify>Run `npm run check:keyframes` -- should pass (zero keyframes in modules). Run `npm run tokens:audit` -- should print a clean report.</verify>
  <done>Both scripts run successfully. check:keyframes confirms zero @keyframes in CSS Modules. tokens:audit prints defined vs used token summary.</done>
</task>

</tasks>

<verification>
1. `npm run check:vars` runs without errors
2. `npm run check:keyframes` runs without errors
3. `npm run tokens:audit` runs without errors and prints meaningful output
4. All three scripts are in `scripts/` directory
5. All three npm scripts are in package.json
</verification>

<success_criteria>
Three analysis scripts exist as reusable npm commands. check:vars validates all var() references resolve. check:keyframes enforces no @keyframes in CSS Modules. tokens:audit provides token usage visibility.
</success_criteria>

<output>
After completion, create `.planning/phases/17-compatibility-verification/17-01-SUMMARY.md`
</output>
