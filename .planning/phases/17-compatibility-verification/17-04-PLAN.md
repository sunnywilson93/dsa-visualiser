---
phase: 17-compatibility-verification
plan: 04
type: execute
wave: 2
depends_on: ["17-02"]
files_modified:
  - playwright.config.ts
  - e2e/visual-regression.spec.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Playwright visual regression tests capture screenshots of all page routes at 360px, 768px, and 1440px viewports"
    - "Baseline screenshots are generated and stored for future comparison"
    - "Animation state is controlled to prevent flaky screenshots (reducedMotion enabled)"
  artifacts:
    - path: "playwright.config.ts"
      provides: "Playwright configuration with viewport matrix and screenshot settings"
      min_lines: 20
    - path: "e2e/visual-regression.spec.ts"
      provides: "Visual regression test covering all routes at 3 viewports"
      min_lines: 40
  key_links:
    - from: "package.json"
      to: "playwright.config.ts"
      via: "npm script test:visual"
      pattern: "test:visual"
---

<objective>
Set up Playwright visual regression testing infrastructure with screenshot comparison tests for all page routes at 360px, 768px, and 1440px viewports.

Purpose: Visual regression tests become the permanent CI safety net for the design system. Any future token change that alters page appearance will be caught by screenshot diffs. Baselines established here represent the pre-migration visual state.

Output: Playwright config, visual regression spec file, npm script, and baseline screenshots.
</objective>

<execution_context>
@/Users/sunnywilson/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sunnywilson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-compatibility-verification/17-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set up Playwright configuration and install dependencies</name>
  <files>playwright.config.ts, package.json</files>
  <action>
Install Playwright as a dev dependency and download Chromium:
```bash
npm install -D @playwright/test
npx playwright install chromium
```

Create `playwright.config.ts` at the project root with:

```typescript
import { defineConfig } from '@playwright/test'

export default defineConfig({
  testDir: './e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:3000',
    // Disable animations for consistent screenshots
    reducedMotion: 'reduce',
    // No animations, transitions, or smooth scrolling
    launchOptions: {
      args: ['--force-prefers-reduced-motion'],
    },
  },
  // Build and start production server for consistent rendering
  webServer: {
    command: 'npm run build && npm run start',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
    timeout: 120000,
  },
  projects: [
    {
      name: 'desktop-1440',
      use: { viewport: { width: 1440, height: 900 } },
    },
    {
      name: 'tablet-768',
      use: { viewport: { width: 768, height: 1024 } },
    },
    {
      name: 'mobile-360',
      use: { viewport: { width: 360, height: 640 } },
    },
  ],
  // Screenshot comparison settings
  expect: {
    toHaveScreenshot: {
      maxDiffPixels: 0,
      animations: 'disabled',
    },
  },
})
```

Add npm scripts to package.json:
- `"test:visual": "npx playwright test"`
- `"test:visual:update": "npx playwright test --update-snapshots"`

Add to .gitignore if not present: `playwright-report/`, `test-results/`
  </action>
  <verify>Run `npx playwright --version` to confirm Playwright is installed.</verify>
  <done>Playwright installed with Chromium. Config file exists with 3 viewport projects, animation disabled, production server configured.</done>
</task>

<task type="auto">
  <name>Task 2: Create visual regression test spec with all routes</name>
  <files>e2e/visual-regression.spec.ts</files>
  <action>
Create `e2e/visual-regression.spec.ts` that screenshots all accessible page routes.

The route templates are:
1. `/` -- Home page
2. `/concepts` -- Concepts overview
3. `/concepts/js` -- JS concepts listing
4. `/concepts/dsa` -- DSA concepts listing
5. `/concepts/[conceptId]` -- Individual JS concept pages (need to enumerate from data)
6. `/concepts/dsa/[conceptId]` -- Individual DSA concept pages
7. `/concepts/dsa/patterns/[patternId]` -- DSA pattern pages (two-pointers, hash-map, bit-manipulation)
8. `/[categoryId]` -- Problem category listing
9. `/[categoryId]/[problemId]` -- Practice page (has code editor -- screenshot may vary)
10. `/[categoryId]/[problemId]/concept` -- Algorithm concept page
11. `/js-problems` -- JS problems page
12. `/playground/event-loop` -- Event loop playground

For the test:

```typescript
import { test, expect } from '@playwright/test'

// Static routes that always exist
const staticRoutes = [
  { path: '/', name: 'home' },
  { path: '/concepts', name: 'concepts' },
  { path: '/concepts/js', name: 'concepts-js' },
  { path: '/concepts/dsa', name: 'concepts-dsa' },
  { path: '/js-problems', name: 'js-problems' },
]

// DSA pattern routes
const patternRoutes = [
  { path: '/concepts/dsa/patterns/two-pointers', name: 'pattern-two-pointers' },
  { path: '/concepts/dsa/patterns/hash-map', name: 'pattern-hash-map' },
  { path: '/concepts/dsa/patterns/bit-manipulation', name: 'pattern-bit-manipulation' },
]

// To discover dynamic routes, import from the data files:
// - JS concept IDs from src/data/concepts.ts
// - Category/problem IDs from src/data/ files
// For now, enumerate a representative set of known routes.
// The executor should read the actual data files (concepts.ts, problems.ts, categories)
// to build the full route list. Include ALL routes, not a sample.

test.describe('Visual Regression', () => {
  for (const route of [...staticRoutes, ...patternRoutes]) {
    test(`${route.name} renders correctly`, async ({ page }) => {
      await page.goto(route.path)
      // Wait for content to load and animations to settle
      await page.waitForLoadState('networkidle')
      // Additional wait for any CSS transitions to complete
      await page.waitForTimeout(500)
      await expect(page).toHaveScreenshot(`${route.name}.png`, {
        fullPage: true,
      })
    })
  }
})
```

IMPORTANT: The executor MUST read the following data files to enumerate ALL dynamic routes:

1. `src/data/concepts.ts` — exports `concepts: Concept[]`. Each entry has an `id` field. Generate `/concepts/{id}` routes for each.
2. `src/data/dsaConcepts.ts` — exports `dsaConcepts: DSAConcept[]`. Each entry has an `id` field. Generate `/concepts/dsa/{id}` routes for each.
3. `src/data/dsaPatterns.ts` — exports `DSA_PATTERN_IDS` array (`['two-pointers', 'hash-map', 'bit-manipulation']`) and `dsaPatterns: DSAPattern[]`. Generate `/concepts/dsa/patterns/{id}` routes for each.
4. `src/data/examples.ts` — exports:
   - `exampleCategories` array (9 categories, each with `id` field: `js-core`, `async-js`, `array-polyfills`, `utility-functions`, `functional-js`, `dom-events`, `object-utils`, `promise-polyfills`, `dsa`). Generate `/{categoryId}` routes for each.
   - `dsaSubcategories` array (19 DSA sub-categories, each with `id` field: `arrays-hashing`, `two-pointers`, `sliding-window`, `stack`, `binary-search`, `linked-list`, `strings`, `sorting`, `recursion`, `dynamic-programming`, `greedy`, `backtracking`, `graphs`, `trees`, `trie`, `heap`, `intervals`, `bit-manipulation`, `math`). These are also valid `/{categoryId}` routes.
   - `codeExamples: CodeExample[]` — each has `id` (problemId) and `category` (categoryId) fields. These define `/[categoryId]/[problemId]` routes.
5. `src/data/algorithmConcepts.ts` — exports `problemConcepts: Record<string, ProblemConcept>`. The keys are problem IDs that have concept pages. Generate `/[categoryId]/[problemId]/concept` routes only for problems whose ID appears as a key in `problemConcepts`.

Route generation rules:
- Skip individual problem practice pages (`/[categoryId]/[problemId]`) as they contain Monaco editor which renders differently each time
- Include concept pages (`/[categoryId]/[problemId]/concept`) only for problems that have entries in `problemConcepts`
- No other data files in `src/data/` define routes

Use `page.waitForLoadState('networkidle')` and `page.waitForTimeout(500)` before each screenshot to ensure content is fully rendered.

Use `fullPage: true` for screenshots to capture entire scrollable content.
  </action>
  <verify>Run `npm run test:visual:update` to generate baseline screenshots. All tests should pass on first run (baseline creation). Then run `npm run test:visual` to confirm screenshots match baselines.</verify>
  <done>Visual regression spec covers all page routes. Baseline screenshots generated at 3 viewports. Re-running tests confirms zero pixel differences.</done>
</task>

</tasks>

<verification>
1. `playwright.config.ts` exists with 3 viewport projects
2. `e2e/visual-regression.spec.ts` exists with tests for all routes
3. `npm run test:visual:update` generates baseline screenshots
4. `npm run test:visual` passes with zero diff pixels
</verification>

<success_criteria>
Playwright visual regression infrastructure is complete. Baseline screenshots exist for all pages at 360px, 768px, and 1440px. Running tests confirms zero visual differences.
</success_criteria>

<output>
After completion, create `.planning/phases/17-compatibility-verification/17-04-SUMMARY.md`
</output>
